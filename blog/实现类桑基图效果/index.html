<!doctype html><html lang=en-us><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?9fb3cda71a61f7006356f0c75fac487d";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>实现类桑基图展示数据关系 - CocaColf</title><meta property="og:title" content="实现类桑基图展示数据关系 - CocaColf"><meta name=twitter:card content="summary"><meta property="description" content="最近开发的页面中，有如下所示的板块，它展示了左右两侧信息的数据关系。
[&amp;hellip;] 最初，交互设计师和我说这种设计图叫桑基图。我检索后，发现 ECharts 就有桑基图效果，于是我想可以基于其进行二次开发。在阅读文档后，我发现 ECharts 的桑基图可以自定义的部分不多，非常不灵活，我们的左侧和右侧板块的效果完全无法实现。好了，那就自己来了。
[&amp;hellip;] 将整个设计抽象为三个组 &amp;hellip;"><meta property="og:description" content="最近开发的页面中，有如下所示的板块，它展示了左右两侧信息的数据关系。
[&amp;hellip;] 最初，交互设计师和我说这种设计图叫桑基图。我检索后，发现 ECharts 就有桑基图效果，于是我想可以基于其进行二次开发。在阅读文档后，我发现 ECharts 的桑基图可以自定义的部分不多，非常不灵活，我们的左侧和右侧板块的效果完全无法实现。好了，那就自己来了。
[&amp;hellip;] 将整个设计抽象为三个组 &amp;hellip;"><meta name=twitter:image content="https://blog-1305900062.cos.ap-guangzhou.myqcloud.com/blog_pic/%E5%88%86%E5%B1%82.jpg"><link href=//cdn.bootcss.com/highlight.js/9.12.0/styles/monokai.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css></head><body class=blog><header class=masthead><h1><a href=/>CocaColf</a></h1><p class=tagline>庭前桃李满，院外小径芳</p><nav class=menu><input id=menu-check type=checkbox hidden>
<label id=menu-label for=menu-check class=unselectable hidden><span class="icon close-icon">✕</span>
<span class="icon open-icon">☰</span>
<span class=text>Menu</span></label><ul><li><a href=/tags/writing/>文字</a></li><li><a href=/tags/technical/>技术</a></li><li><a href=/about/>关于</a></li><li><a href=/tags/>标签</a></li><li><a href=/index.xml>订阅</a></li></ul></nav></header><article class=main><header class=title><h1>实现类桑基图展示数据关系</h1><h3>2020-09-01</h3><hr></header><p>最近开发的页面中，有如下所示的板块，它展示了左右两侧信息的数据关系。</p><p><img src=https://blog-1305900062.cos.ap-guangzhou.myqcloud.com/blog_pic/%E5%88%86%E5%B1%82.jpg alt=效果图></p><ul><li>左边是类似表格的列表，每一行右侧有一根比例图柱子，可以看到柱子有黄色和蓝色两种颜色分层</li><li>右侧是存储设备全局的信息，这个设备分为性能层和容量层，水球图一黄一蓝来区分</li><li>左侧和右侧中间有一条顺滑的曲线从左侧的每一根柱子连接到右侧，柱子的起点的颜色连接同色的右侧水球。连线的宽度和柱子颜色的比例成正比，同时这里有个看不出来的动态效果——每根连线里有一颗“能量球”沿着连线流动</li></ul><hr><p>最初，交互设计师和我说这种设计图叫<a href=https://www.zhihu.com/question/45502919>桑基图</a>。我检索后，发现 <a href=https://echarts.apache.org/zh/index.html>ECharts</a> 就有桑基图<a href=https://echarts.apache.org/examples/zh/index.html#chart-type-sankey>效果</a>，于是我想可以基于其进行二次开发。在阅读文档后，我发现 ECharts 的桑基图可以自定义的部分不多，非常不灵活，我们的左侧和右侧板块的效果完全无法实现。好了，那就自己来了。</p><h2 id=分析>分析</h2><p>将整个设计抽象为三个组件：</p><ul><li>左侧类似于表格的组件</li><li>中间绘图（连线）区域</li><li>右侧分层容量展示区域</li></ul><p>左侧和右侧很好实现，因此问题在于连线部分。连线部分主要有两点：</p><ul><li>左侧”表格“中每一行的右边框那根柱子，黄色的容量要连上右侧容量展示区域的黄色球，蓝色连上蓝色球</li><li>连线需要和尺寸无关，即浏览器缩放，连线依然准确。换言之，连线坐标不能写死，要动态计算</li></ul><h2 id=实现>实现</h2><p>实现连线我有两种方案可选： Canvas 或 Svg 实现。我发现这个场景特别适合 Svg，因为它和 HTML 可以结合得很好，而且连线的绘制非常简单，使用它提供的 path 标签即可连线。两点确定一条线，那么问题的关键就成了如何确定起始坐标。</p><p><strong>结构设计</strong></p><p>从 HTML 结构自上而下来说，整个视图分为两层：</p><ol><li>第一层是组件层，即容纳左侧“表格”和右侧球信息的层</li><li>第二层是 Svg 连线层</li></ol><p>这两层都容纳在同一个大容器内，每一层的宽度和高度都和最外层的容器一样大小。这里必须要将连线层放在组件层之下，因为如果不这样，那么组件层中像鼠标悬浮到某个元素显示信息气泡的效果就无法实现，因为鼠标悬浮到的实际上是连线层。</p><p><img src=https://blog-1305900062.cos.ap-guangzhou.myqcloud.com/%E6%A1%91%E5%9F%BA%E5%9B%BE_HTML%E7%BB%93%E6%9E%84.png alt=结构图></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;container&#34;</span>&gt;
	&lt;<span style=color:#f92672>line</span> /&gt;
	&lt;<span style=color:#f92672>component-layer</span> /&gt;
&lt;/<span style=color:#f92672>div</span>&gt;
</code></pre></div><p><strong>连线</strong></p><p>开始绘制连线，以左侧某一行和右侧连接为例：</p><p>如何获取起点？起点是左侧柱子的位置坐标，我们可以通过获取柱子的 dom 元素，使用 <code>getBoundingClientRect</code> api 获取这个元素相对于容器的位置信息 leftSide，那么这个柱子的位置则是 <code>(leftSide.right, leftSide.top)</code>。</p><p>同理获取终点坐标 <code>(rightSide.right, rightSide.top)</code>。</p><p>这里有个要注意的事情，我们连线是使用 Svg path 连线，那么这个坐标信息应当是相对于 Svg 层的位置。即我们要从 Svg 的起点到我们算出来的某个点的位置需要平移多少，因此我们也需要用同样的方式得到 Svg 层的坐标信息 SvgPosition。</p><p>到这里，某一根线的点信息就很简单了，以柱子里的黄色层为例：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>startPoint</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>X</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>leftSide</span>.<span style=color:#a6e22e>right</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>svgPosition</span>.<span style=color:#a6e22e>left</span>,
    <span style=color:#a6e22e>Y</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>leftSide</span>.<span style=color:#a6e22e>top</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>左边表格的某一行的右边缘柱子的高度</span><span style=color:#f92672>*</span><span style=color:#a6e22e>黄色容量所占比例</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>svgPosition</span>.<span style=color:#a6e22e>top</span>

}

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>endPosition</span> <span style=color:#f92672>=</span> {
    <span style=color:#a6e22e>X</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>rightSide</span>.<span style=color:#a6e22e>left</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>svgPosition</span>.<span style=color:#a6e22e>left</span>
    <span style=color:#a6e22e>Y</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>rightSide</span>.<span style=color:#a6e22e>top</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>球的半径</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>svgPosition</span>.<span style=color:#a6e22e>top</span>
}
</code></pre></div><p><img src=https://blog-1305900062.cos.ap-guangzhou.myqcloud.com/%E8%BF%9E%E7%BA%BF%E7%A4%BA%E6%84%8F%E5%9B%BE.png alt=连线示意图></p><p>不过这样的线是直线，因此可以使用一些数学计算来美化这条连线，我采用的是一次贝塞尔曲线。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>PositionInfo</span> {
	<span style=color:#a6e22e>x</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>number</span>,
	<span style=color:#a6e22e>y</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>number</span>
}

<span style=color:#75715e>/**
</span><span style=color:#75715e>* 一次贝塞尔曲线
</span><span style=color:#75715e>*/</span>
<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>oneBezire</span> (<span style=color:#a6e22e>start</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PositionInfo</span>, <span style=color:#a6e22e>end</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>PositionInfo</span>) {
	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>TWO</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;

    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>ret</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`M </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>start</span>.<span style=color:#a6e22e>x</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>start</span>.<span style=color:#a6e22e>y</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>cpx1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>start</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>end</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>start</span>.<span style=color:#a6e22e>x</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>CURVATURE</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>TWO</span>;
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>cpy1</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>start</span>.<span style=color:#a6e22e>y</span>;
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>cpx2</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>start</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>TWO</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>end</span>.<span style=color:#a6e22e>x</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>TWO</span>;
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>cpy2</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>start</span>.<span style=color:#a6e22e>y</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>TWO</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>end</span>.<span style=color:#a6e22e>y</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>TWO</span>;
    <span style=color:#a6e22e>ret</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>` Q </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cpx1</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cpy1</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cpx2</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>cpy2</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
    <span style=color:#a6e22e>ret</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>` T </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>end</span>.<span style=color:#a6e22e>x</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>end</span>.<span style=color:#a6e22e>y</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
    
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ret</span>;
}
</code></pre></div><p>将计算出来的 Svg path 规则赋给 Svg path 属性即可绘制连线。</p><p>其余连线的绘制都是一模一样的，因此我们只需要获取到左侧的容器 dom，遍历其所有的每一行子元素去计算位置信息即可获得所有的连线信息。</p><p>由于位置信息都是动态计算的，因此在不同的分辨率下或缩放浏览器，连线的位置都不会错乱。</p><hr><h2 id=其他>其他</h2><p><strong>流珠如何实现？</strong></p><p>使用 Svg circle 和 animateMotion 属性配置即可完成动态流珠。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>circle</span> <span style=color:#a6e22e>:cx</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>
        <span style=color:#a6e22e>:cy</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span>
        <span style=color:#a6e22e>:r</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2&#34;</span>
        <span style=color:#a6e22e>:fill</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;#ccc&#34;</span>&gt;

    &lt;<span style=color:#f92672>animateMotion</span> <span style=color:#a6e22e>:path</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;流珠的滑动路径，和线的路径一致&#34;</span>
                   <span style=color:#a6e22e>begin</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0s&#34;</span>
                   <span style=color:#a6e22e>dur</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;5s&#34;</span>
                   <span style=color:#a6e22e>repeatCount</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;indefinite&#34;</span>
                   <span style=color:#a6e22e>rotate</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;auto&#34;</span>/&gt; 
&lt;/<span style=color:#f92672>circle</span>&gt;
</code></pre></div><h4>Comments:</h4><div id=cusdis_thread data-host=https://cusdis.com data-app-id=a2f9224a-c294-4108-998e-c8818b5dec9e data-page-id=cocacolf-blog data-page-url=https://cocacolf.github.io data-page-title="my blog"></div><script async defer src=https://cusdis.com/js/cusdis.es.js></script><footer><script src=//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.12.0/languages/javascript.min.js></script><script src=//cdn.bootcss.com/highlight.js/9.12.0/languages/js.min.js></script><script>hljs.configure({languages:[]});hljs.initHighlightingOnLoad();</script><hr><div class=copyright>© CocaColf | <a href=https://github.com/CocaColf>Github</a></div></footer></article></body></html>